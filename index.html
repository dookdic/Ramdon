<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Ç‡πà‡∏á‡∏°‡πâ‡∏≤ (Fixed Finish Line)</title>
    <!-- ‡πÉ‡∏ä‡πâ Font ‡∏™‡∏ß‡∏¢‡πÜ ‡∏à‡∏≤‡∏Å Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #000;
            color: white;
            margin: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
        }

        #gameWrapper {
            width: 100%;
            max-width: 177.78vh; /* 16/9 aspect ratio */
            aspect-ratio: 16/9;
            max-height: 100vh;
            position: relative;
            background-color: #1a202c;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏´‡∏ç‡πâ‡∏≤ */
        .track-bg {
            background-color: #38a169;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='80' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='0' y1='99' x2='50' y2='99' stroke='rgba(255,255,255,0.3)' stroke-width='2'/%3E%3C/svg%3E"),
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 1px, transparent 1px),
                repeating-linear-gradient(90deg, transparent 0, transparent 99px, rgba(255,255,255,0.1) 100px);
            background-size: auto 10%, 20px 20px, auto auto;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.6);
        }

        .finish-line {
            background-image: 
                linear-gradient(45deg, #000 25%, transparent 25%), 
                linear-gradient(-45deg, #000 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #000 75%), 
                linear-gradient(-45deg, transparent 75%, #000 75%);
            background-size: 20px 20px;
            background-color: rgba(255,255,255,0.9);
        }

        .horse-run {
            will-change: transform;
        }

        .force-show-name {
            opacity: 1 !important;
            transform: scale(1.1);
            z-index: 50;
        }

        /* --- Dust Effect Styles --- */
        .dust-container {
            position: absolute;
            left: -15px; /* ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á */
            bottom: -5px;
            width: 40px;
            height: 30px;
            pointer-events: none;
            z-index: -1; /* ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏°‡πâ‡∏≤ */
            opacity: 0;
            transition: opacity 0.9s ease-out;
        }
        
        .dust-container.active {
            opacity: 1;
        }

        .dust-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: rgba(220, 220, 220, 0.6);
            border-radius: 50%;
            opacity: 0;
        }

        .dust-container.active .dust-particle {
            animation: dust-puff 0.5s infinite linear;
        }

        .dust-container.active .dust-particle:nth-child(1) { left: 25px; bottom: 5px; animation-delay: 0s; transform: scale(0.8); }
        .dust-container.active .dust-particle:nth-child(2) { left: 15px; bottom: 2px; animation-delay: 0.15s; transform: scale(1.2); }
        .dust-container.active .dust-particle:nth-child(3) { left: 5px; bottom: 8px; animation-delay: 0.3s; transform: scale(0.6); }

        @keyframes dust-puff {
            0% { transform: scale(0.5) translate(0, 0); opacity: 0.7; }
            100% { transform: scale(2.5) translate(-20px, -15px); opacity: 0; }
        }

        /* --- Fireworks Canvas --- */
        #fireworksCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
        }

        /* --- Countdown Animation --- */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Tab Styles */
        .tab-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
        }
        
        /* Custom Select */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }

    </style>
</head>
<body>

    <!-- Canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏•‡∏∏ -->
    <canvas id="fireworksCanvas"></canvas>

    <div id="gameWrapper">
        <!-- Header -->
        <header class="bg-gray-900 bg-opacity-95 p-3 shadow-md z-30 border-b border-gray-700 flex-shrink-0">
            <div class="flex flex-row justify-between items-center px-4">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl md:text-2xl font-bold text-yellow-400 hidden md:block">
                        üèÅ Race
                    </h1>
                    
                    <!-- Group Selector (Visible only in Group Mode) -->
                    <div id="groupSelectorContainer" class="hidden">
                        <label class="text-xs text-gray-400 block mb-0.5">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô:</label>
                        <select id="raceGroupSelect" class="bg-gray-800 text-white text-sm border border-gray-600 rounded px-3 py-1 pr-8 focus:outline-none focus:border-blue-500 w-48">
                            <option value="1">1. ‡∏≠‡∏™‡∏Ñ (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
                            <option value="2">2. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ù‡πà‡∏≤‡∏¢</option>
                            <option value="3">3. ‡∏Å‡∏õ‡∏™-‡∏û.</option>
                            <option value="4">4. ‡∏Å‡∏ï‡∏™-‡∏û.</option>
                            <option value="5">5. ‡∏Å‡∏™‡∏™-‡∏û.</option>
                            <option value="6">6. ‡∏Å‡∏ö‡∏£-‡∏û.</option>
                        </select>
                    </div>

                    <!-- Simple Mode Label -->
                    <div id="simpleModeLabel" class="text-sm bg-gray-700 text-gray-300 px-2 py-1 rounded">
                        ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
                    </div>
                </div>
                
                <div class="flex gap-3 items-center text-sm md:text-base">
                    <div class="flex items-center gap-2 bg-gray-800 rounded px-2 py-1">
                        <label class="text-gray-300">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•:</label>
                        <input type="number" id="winnerCount" value="3" min="1" max="50" class="w-12 bg-transparent text-center focus:outline-none font-bold text-yellow-400 border-b border-gray-600">
                    </div>
                    <button id="setupBtn" onclick="toggleSetup()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded shadow transition flex items-center gap-1">
                        ‚öôÔ∏è <span class="hidden sm:inline">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤/‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</span>
                    </button>
                    <button id="startBtn" onclick="prepareAndStart()" class="bg-red-600 hover:bg-red-500 text-white px-5 py-1.5 rounded shadow font-bold transition transform hover:scale-105">
                        üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á!
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Race Area -->
        <main class="flex-1 relative track-bg overflow-hidden" id="trackArea">
            <div id="worldContainer" class="absolute inset-0 will-change-transform">
                <div id="markersLayer" class="absolute inset-0 z-0"></div>
                <div id="racersLayer" class="absolute inset-0 z-10">
                     <div class="flex flex-col items-center justify-center h-full w-screen text-gray-300 opacity-50 space-y-2 animate-pulse">
                        <div class="text-6xl">üèüÔ∏è</div>
                        <div class="text-2xl" id="trackMessage">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
                        <div class="text-sm">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
                    </div>
                </div>
                <div id="finishLine" class="absolute top-0 bottom-0 w-4 finish-line z-0 shadow-lg hidden"></div>
                <div id="finishLabel" class="absolute top-1/2 transform -translate-y-1/2 rotate-90 text-white font-bold tracking-widest opacity-30 text-6xl pointer-events-none select-none hidden" style="white-space: nowrap;">
                    FINISH LINE
                </div>
            </div>

            <!-- Countdown Overlay -->
            <div id="countdownOverlay" class="absolute inset-0 z-50 flex items-center justify-center pointer-events-none hidden bg-black bg-opacity-20">
                <div id="countdownText" class="text-[10rem] font-black text-white drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] stroke-black" style="-webkit-text-stroke: 4px black;">
                    3
                </div>
            </div>
        </main>
        
        <div class="bg-gray-900 text-xs text-gray-400 px-4 py-1 flex justify-between z-20">
            <span id="racerCountDisplay">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: 0 ‡∏Ñ‡∏ô</span>
            <span id="distanceDisplay">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: 0 M</span>
        </div>
    </div>

    <!-- Modals -->
    <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-4xl shadow-2xl border border-gray-600 relative m-4 flex flex-col h-[90vh]">
            <button onclick="toggleSetup()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            
            <h2 class="text-xl font-bold mb-4 text-blue-400 flex items-center gap-2">
                üìã ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
            </h2>

            <!-- Mode Switcher -->
            <div class="flex bg-gray-700 p-1 rounded-lg mb-4 w-fit">
                <button onclick="setMode('simple')" id="btnModeSimple" class="px-4 py-2 rounded-md text-sm font-medium transition-all tab-btn active">‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (1 ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)</button>
                <button onclick="setMode('group')" id="btnModeGroup" class="px-4 py-2 rounded-md text-sm font-medium transition-all tab-btn">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (6 ‡∏Å‡∏•‡∏∏‡πà‡∏°)</button>
            </div>

            <!-- Simple Mode Input -->
            <div id="simpleModeContainer" class="flex-1 flex flex-col min-h-0">
                <div class="bg-gray-700 p-3 rounded mb-2 flex items-center gap-2">
                    <span class="text-sm">‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</span>
                    <input type="number" id="genAmount" value="50" class="w-20 px-2 py-1 text-black rounded text-center" min="1" max="1000">
                    <button onclick="generateData()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded text-sm transition">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button>
                </div>
                <textarea id="nameList" class="flex-1 w-full p-3 bg-gray-900 text-white text-sm rounded border border-gray-600 focus:border-blue-500 focus:outline-none resize-none font-mono" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ‡∏ä‡∏∑‡πà‡∏≠)..."></textarea>
                <div class="text-right text-xs text-gray-400 mt-1" id="lineCountSimple">0 ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
            </div>

            <!-- Group Mode Input -->
            <div id="groupModeContainer" class="flex-1 flex flex-col min-h-0 hidden">
                <!-- Group Tabs -->
                <div class="flex gap-2 overflow-x-auto pb-2 mb-2 border-b border-gray-700" id="groupTabs">
                    <!-- JS will populate tabs -->
                </div>
                
                <!-- Group Content -->
                <div class="flex-1 relative bg-gray-900 rounded border border-gray-600">
                     <textarea id="groupInputArea" class="absolute inset-0 w-full h-full p-3 bg-transparent text-white text-sm focus:outline-none resize-none font-mono"></textarea>
                     <!-- Overlay for Group 1 (ReadOnly) -->
                     <div id="group1Overlay" class="absolute inset-0 bg-gray-800 bg-opacity-90 flex flex-col items-center justify-center hidden pointer-events-none">
                        <div class="text-4xl">üîí</div>
                        <div class="text-xl font-bold mt-2">1. ‡∏≠‡∏™‡∏Ñ (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>
                        <div class="text-sm text-gray-400 mt-1">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° 2-6 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                        <div class="text-lg text-yellow-400 mt-4" id="group1TotalDisplay">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: 0 ‡∏Ñ‡∏ô</div>
                     </div>
                </div>
                <div class="flex justify-between items-center mt-2">
                     <div class="text-xs text-yellow-500">* ‡∏Å‡∏•‡∏∏‡πà‡∏° 1 (‡∏≠‡∏™‡∏Ñ) ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° 2-6 ‡πÄ‡∏™‡∏°‡∏≠</div>
                     <div class="text-xs text-gray-400" id="groupCurrentCount">0 ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
                </div>
            </div>

            <div class="flex justify-end items-center mt-4 pt-4 border-t border-gray-700">
                <button onclick="saveAndCloseSetup()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-2 rounded font-bold shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="absolute inset-0 z-50 hidden flex items-center justify-center pointer-events-none">
        <div class="bg-white text-gray-900 rounded-xl w-full max-w-md shadow-2xl transform scale-90 opacity-0 transition-all duration-300 pointer-events-auto border-4 border-yellow-400 overflow-hidden flex flex-col max-h-[80vh]">
            <div class="bg-red-600 text-white p-4 text-center font-bold text-2xl shadow-md">üèÜ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
            <div class="bg-gray-100 px-4 py-2 text-center text-sm font-bold text-gray-600 border-b" id="resultSubtitle">
                ‡∏Å‡∏•‡∏∏‡πà‡∏°: -
            </div>
            <ul id="winnerList" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50 text-base"></ul>
            <div class="p-4 bg-gray-100 border-t flex flex-col gap-2">
                <button onclick="nextRound()" class="bg-blue-600 hover:bg-blue-500 text-white text-lg px-6 py-3 rounded-lg font-bold shadow-lg transition hover:scale-105 flex items-center justify-center gap-2">
                    ‚è≠Ô∏è ‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ (‡∏Ñ‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏≠‡∏≠‡∏Å)
                </button>
                <button onclick="closeResult()" class="text-gray-500 hover:text-gray-800 text-sm py-1 font-semibold underline">
                    ‡∏õ‡∏¥‡∏î (‡∏Ñ‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ)
                </button>
            </div>
        </div>
    </div>

<script>
    // --- Config & State ---
    const avatars = ['üêé', 'ü¶Ñ', 'üêÜ', 'üêÖ', 'ü¶ì', 'üêï', 'üêá', 'üèá', 'üö¥', 'üèéÔ∏è', 'üõµ', 'üèÉ', 'ü¶ñ', 'üêÇ'];
    const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'];
    const TRACK_MULTIPLIER = 4;

    let isRacing = false;
    let racers = [];
    let winners = [];
    let raceInterval = null;
    let targetWinners = 3;
    let finishLineX = 0;
    let viewportWidth = 0;
    let viewportHeight = 0;
    let frameTick = 0;
    
    // Group Mode State
    let currentMode = 'simple'; // 'simple' or 'group'
    let activeGroupTab = 0; 
    
    // Data storage for groups 2-6
    const groupData = {
        2: [], 3: [], 4: [], 5: [], 6: []
    };
    
    const groupConfig = {
        1: { name: '1. ‡∏≠‡∏™‡∏Ñ', color: 'bg-gray-600' },
        2: { name: '2. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ù‡πà‡∏≤‡∏¢', color: 'bg-red-600' },
        3: { name: '3. ‡∏Å‡∏õ‡∏™-‡∏û.', color: 'bg-blue-600' },
        4: { name: '4. ‡∏Å‡∏ï‡∏™-‡∏û.', color: 'bg-green-600' },
        5: { name: '5. ‡∏Å‡∏™‡∏™-‡∏û.', color: 'bg-yellow-600' },
        6: { name: '6. ‡∏Å‡∏ö‡∏£-‡∏û.', color: 'bg-purple-600' }
    };

    // --- Sound Manager (Web Audio API) ---
    const SoundManager = {
        ctx: null,
        bgmInterval: null,
        
        init: function() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            } else if (this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },
        
        playTone: function(freq, type, duration, startTime = 0, vol = 0.1) {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime + startTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start(this.ctx.currentTime + startTime);
            osc.stop(this.ctx.currentTime + startTime + duration);
        },

        playBeep: function(freq) {
            this.playTone(freq, 'square', 0.1, 0, 0.1);
        },

        playVictory: function() {
            this.init();
            const now = 0;
            this.playTone(523.25, 'triangle', 0.2, now, 0.2);
            this.playTone(659.25, 'triangle', 0.2, now + 0.1, 0.2);
            this.playTone(783.99, 'triangle', 0.2, now + 0.2, 0.2);
            this.playTone(1046.50, 'square', 0.6, now + 0.3, 0.2);
        },

        playFireworkPop: function() {
            this.init();
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.frequency.setValueAtTime(100, t);
            osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start(t);
            osc.stop(t + 0.5);
        },

        playRaceMusic: function() {
            this.init();
            this.stopRaceMusic(); 

            const tempo = 0.13; // Faster tempo
            // Simple fast-paced 8-bit melody
            // C5 G4 C5 E5 | F5 C5 F5 A5 | G5 D5 G5 B5 | C6 ...
            const melody = [
                523.25, 392.00, 523.25, 659.25, // C, G, C, E
                698.46, 523.25, 698.46, 880.00, // F, C, F, A
                783.99, 587.33, 783.99, 987.77, // G, D, G, B
                1046.50, 783.99, 523.25, 392.00 // C6, G, C, G
            ];
            
            let noteIndex = 0;

            this.bgmInterval = setInterval(() => {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                
                // Main Melody (Square)
                const noteFreq = melody[noteIndex % melody.length];
                this.playTone(noteFreq, 'square', 0.08, 0, 0.08); // Short & crisp
                
                // Bass Line (Triangle) - Every 2nd note
                if (noteIndex % 2 === 0) {
                     const bassFreq = (noteIndex % 8 < 4) ? 261.63 : 196.00; // C4 then G3
                     this.playTone(bassFreq, 'triangle', 0.2, 0, 0.15); 
                }

                noteIndex++;
            }, tempo * 1000); 
        },

        stopRaceMusic: function() {
            if (this.bgmInterval) {
                clearInterval(this.bgmInterval);
                this.bgmInterval = null;
            }
        }
    };

    // --- Elements ---
    const setupModal = document.getElementById('setupModal');
    const resultModal = document.getElementById('resultModal');
    const racersLayer = document.getElementById('racersLayer');
    const markersLayer = document.getElementById('markersLayer');
    const worldContainer = document.getElementById('worldContainer');
    const trackArea = document.getElementById('trackArea');
    const finishLine = document.getElementById('finishLine');
    const finishLabel = document.getElementById('finishLabel');
    const startBtn = document.getElementById('startBtn');
    const distanceDisplay = document.getElementById('distanceDisplay');
    const racerCountDisplay = document.getElementById('racerCountDisplay');
    const countdownOverlay = document.getElementById('countdownOverlay');
    const countdownText = document.getElementById('countdownText');
    const groupSelectorContainer = document.getElementById('groupSelectorContainer');
    const simpleModeLabel = document.getElementById('simpleModeLabel');
    const raceGroupSelect = document.getElementById('raceGroupSelect');

    const nameListInput = document.getElementById('nameList');
    const groupInputArea = document.getElementById('groupInputArea');
    const group1Overlay = document.getElementById('group1Overlay');

    // --- Initialization ---
    initGroupTabs();
    generateData(); // Gen simple data
    
    // Group Data Presets
    groupData[2] = ["‡∏ô‡∏≤‡∏¢‡∏ä‡∏±‡∏¢‡∏¢‡∏® ‡∏´‡∏≤‡∏ç‡∏≠‡∏°‡∏£","‡∏ô‡∏≤‡∏á‡∏û‡∏£‡∏ó‡∏¥‡∏û‡∏¢‡πå  ‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏≤‡∏¢","‡∏ô‡∏≤‡∏¢‡∏õ‡∏Å‡∏£‡∏ì‡πå  ‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡∏ó‡∏≠‡∏á","‡∏ô‡∏≤‡∏á‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏≤‡∏ñ  ‡∏®‡∏¥‡∏£‡∏¥‡∏≠‡∏±‡∏Å‡∏©‡∏£","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏®‡∏®‡∏¥‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå  ‡∏Ç‡∏≥‡∏®‡∏¥‡∏£‡∏¥","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏à‡∏¥‡∏ï‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå ‡∏™‡∏∏‡∏Ç‡πÄ‡∏Å‡∏©‡∏°","‡∏ô‡∏≤‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ä‡∏ô‡∏Å  ‡∏ß‡∏¥‡∏ß‡∏±‡∏í‡∏ô‡∏≤‡∏ô‡∏ô‡∏ó‡πå","‡∏ô‡∏≤‡∏¢‡∏†‡∏π‡∏£‡∏¥‡∏®‡∏£‡πå ‡∏ß‡∏¥‡∏£‡∏¢‡∏®‡∏¥‡∏£‡∏¥","‡∏ô‡∏≤‡∏á‡∏õ‡∏±‡∏ó‡∏°‡∏≤‡∏†‡∏£‡∏ì‡πå  ‡∏™‡∏∏‡∏Ç‡∏™‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏á","‡∏ô‡∏≤‡∏á‡∏ß‡∏±‡∏ä‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå  ‡∏®‡∏£‡∏µ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏ô‡∏≤‡∏¢‡∏ì‡∏†‡∏±‡∏ó‡∏£ ‡∏î‡∏∏‡∏£‡∏á‡∏Ñ‡πå‡∏û‡∏á‡∏©‡πå‡∏ò‡∏£","‡∏ô‡∏≤‡∏á‡∏à‡∏¥‡∏î‡∏≤‡∏†‡∏≤  ‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°","‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏£‡∏ä‡∏±‡∏¢ ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏°‡∏™‡∏∏‡∏Ç","‡∏ô‡∏≤‡∏¢‡∏ô‡∏¥‡∏Å‡∏£ ‡πÄ‡∏û‡πá‡∏á‡∏û‡∏£‡∏£‡∏ì‡πå","‡∏ô‡∏≤‡∏¢‡∏â‡∏•‡∏≠‡∏á ‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏™‡∏¥‡∏á‡∏´‡πå","‡∏ô‡∏≤‡∏¢‡∏≠‡∏†‡∏¥‡∏£‡∏±‡∏Å‡∏©‡πå ‡∏ö‡∏∏‡∏ç‡πÄ‡∏õ‡πá‡∏á","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏≤‡∏†‡∏±‡∏™‡∏£‡∏≤  ‡∏®‡∏£‡∏µ‡∏á‡∏≤‡∏°‡∏Ç‡∏≥","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏≤‡∏®  ‡∏õ‡∏≤‡∏ô‡∏ô‡∏û‡∏†‡∏≤","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏∏‡∏™‡∏£‡∏≤  ‡∏™‡∏£‡∏ß‡∏•‡∏™‡∏£‡∏£‡∏Ñ‡πå","‡∏ô‡∏≤‡∏¢‡∏õ‡∏¥‡∏ï‡∏¥‡∏†‡∏±‡∏ó‡∏£  ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏Å‡πâ‡∏ß","‡∏ô‡∏≤‡∏¢‡∏ç‡∏≤‡∏ì‡∏õ‡∏£‡∏µ‡∏ä‡∏≤  ‡∏Ñ‡∏≥‡∏°‡∏≤‡∏ö‡∏∏‡∏ï‡∏£","‡∏ô‡∏≤‡∏¢‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡∏£‡∏±‡∏ï‡∏ô‡πå  ‡∏™‡∏∏‡∏ô‡∏ó‡∏£‡∏õ‡∏£‡∏∞‡∏ó‡∏∏‡∏°","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏£‡∏£‡∏ì‡∏ó‡∏¥‡∏û‡∏¢‡πå ‡πÅ‡∏Å‡πâ‡∏ß‡∏ú‡∏±‡∏î","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏®‡∏£‡∏¥‡∏ô‡∏î‡∏≤ ‡∏™‡∏±‡∏á‡∏Ç‡∏ó‡∏¥‡∏û‡∏¢‡πå","‡∏ô‡∏≤‡∏á‡∏õ‡∏£‡∏≤‡∏ì‡∏µ  ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏°‡∏™‡∏∏‡∏Ç","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏≤‡∏à‡∏£‡∏µ‡∏¢‡πå  ‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÄ‡∏û‡πá‡∏á","‡∏ô‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏ä‡∏¥‡∏ï  ‡∏Å‡∏≠‡∏™‡∏∏‡∏ô‡∏ó‡∏£","‡∏ô‡∏≤‡∏¢‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå  ‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á","‡∏ô‡∏≤‡∏¢‡∏ò‡∏µ‡∏£‡∏¢‡∏∏‡∏ó‡∏ò‡πå ‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏´‡∏¥‡∏£‡∏±‡∏ç"]; 
    groupData[3] = ["‡∏ô‡∏≤‡∏á‡∏û‡∏£‡∏®‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå  ‡πÅ‡∏´‡∏•‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏Å‡∏∏‡∏•","‡∏ô‡∏≤‡∏¢‡∏à‡∏¥‡∏ï‡∏ï‡∏Å‡∏≤‡∏ô‡∏ï‡πå  ‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πÄ‡∏™‡∏Å","‡∏ô‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡πå  ‡πÑ‡∏Å‡∏£‡∏Ç‡∏≤‡∏ß","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏®‡∏∏‡∏ó‡∏ò‡∏¥‡∏ô‡∏µ  ‡∏ß‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå","‡∏ô‡∏≤‡∏¢‡∏î‡∏¥‡∏™‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå  ‡∏≠‡∏°‡∏£‡∏≤‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ì‡∏¥‡∏ä‡∏¢‡∏≤  ‡πÇ‡∏£‡∏à‡∏ô‡πå‡πÄ‡∏û‡πá‡∏ç‡πÄ‡∏û‡∏µ‡∏¢‡∏£","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏°‡∏•‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡πå  ‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ó‡∏ß‡∏£‡πÄ‡∏ß‡∏ó‡∏¢‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏•‡∏µ‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏™‡∏£‡∏£‡∏û‡∏≠‡∏∏‡∏î‡∏°","‡∏ô‡∏≤‡∏¢‡∏ò‡∏¥‡∏ï‡∏¥‡∏†‡∏π‡∏°‡∏¥ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ß‡∏á‡∏®‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏•‡∏±‡∏¢‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏õ‡∏π‡∏ú‡πâ‡∏≤","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏†‡∏≤‡∏û‡∏¥‡∏ô‡∏ó‡πå ‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏Å‡∏£‡∏õ‡∏ß‡∏µ‡∏ì‡πå  ‡πÄ‡∏´‡∏°‡∏Å‡∏£‡∏ì‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ò‡∏µ‡∏ï‡∏≤ ‡∏≠‡∏¥‡∏ô‡∏ó‡πÄ‡∏™‡∏ô","‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡∏ï‡∏ô‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå  ‡∏™‡∏≥‡∏•‡∏µ‡∏£‡∏±‡∏ï‡∏ô‡πå","‡∏ô‡∏≤‡∏¢‡∏õ‡∏∏‡∏ñ‡∏∏‡∏ä‡∏ô ‡πÉ‡∏ö‡πÑ‡∏°‡πâ"]; 
    groupData[4] = ["‡∏ô‡∏≤‡∏á‡∏≠‡∏¥‡∏®‡∏£‡∏≤  ‡∏õ‡∏£‡∏∞‡∏ß‡∏µ‡∏ì‡∏ß‡∏£‡∏Å‡∏∏‡∏•","‡∏ô‡∏≤‡∏¢‡∏ß‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå  ‡∏¢‡∏∞‡∏Å‡∏±‡∏ô‡∏°‡∏π‡∏•","‡∏ô‡∏≤‡∏á‡∏ô‡∏û‡∏£‡∏±‡∏ï‡∏ô‡πå  ‡∏ó‡∏≠‡∏á‡∏û‡∏π‡∏•","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏†‡∏±‡∏™‡∏ß‡∏±‡∏ì‡∏ì‡πå ‡∏ô‡πâ‡∏≠‡∏¢‡∏ß‡∏á‡∏®‡πå","‡∏ô‡∏≤‡∏¢‡πÄ‡∏≠‡∏Å‡∏ä‡∏±‡∏¢  ‡∏°‡∏≤‡∏•‡∏≤‡∏û‡∏•","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏∏‡∏ó‡∏ò‡∏¥‡∏ä‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏ä‡∏∞‡∏ï‡∏≤","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ï‡∏£‡∏µ‡∏ß‡∏£‡∏±‡∏ï‡∏°‡πå ‡∏£‡∏∏‡∏à‡∏¥‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πÇ‡∏ä‡∏Ñ","‡∏ô‡∏≤‡∏¢‡∏û‡∏á‡∏®‡πå‡∏ô‡∏≤‡∏ó  ‡∏ó‡∏ß‡∏¢‡πÄ‡∏à‡∏£‡∏¥‡∏ç","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏•‡∏ô‡∏¥‡∏£‡∏≤  ‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏™‡∏£‡∏µ‡∏Å‡∏∏‡∏•","‡∏ô‡∏≤‡∏¢‡∏ß‡∏£‡∏ß‡∏∏‡∏í‡∏¥  ‡∏õ‡∏∏‡∏ì‡∏ë‡∏£‡∏¥‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏ß‡∏¥‡∏Å‡∏≤  ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•","‡∏ô‡∏≤‡∏¢‡∏à‡∏≤‡∏ï‡∏∏‡∏£‡∏á‡∏Ñ‡πå ‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏ô‡∏¥‡∏î‡∏≤  ‡∏ó‡∏≤‡∏£‡∏≤‡∏ä","‡∏ô‡∏≤‡∏¢‡∏û‡∏∏‡∏í‡∏¥‡∏†‡∏±‡∏ó‡∏£ ‡∏Å‡∏≤‡∏ç‡∏à‡πÇ‡∏ô‡∏°‡∏±‡∏¢","‡∏ô‡∏≤‡∏¢‡∏ó‡∏£‡∏á‡πÄ‡∏î‡∏ä  ‡∏Ñ‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á","‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ó‡∏≤‡∏ß‡∏∏‡∏ò  ‡∏°‡∏±‡∏ô‡∏ï‡∏≤‡∏î‡∏¥‡∏•‡∏Å","‡∏ô‡∏≤‡∏¢‡∏≠‡∏í‡∏¥‡∏ä‡∏±‡∏¢  ‡∏®‡∏£‡∏µ‡∏°‡∏≤‡∏•‡∏≤","‡∏ô‡∏≤‡∏¢‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå  ‡∏™‡∏£‡∏∞‡∏™‡∏°","‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏û‡∏à‡∏ô‡πå ‡∏≠‡πà‡∏≤‡∏ß‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏∏‡∏•","‡∏ô‡∏≤‡∏¢‡∏®‡∏∏‡∏†‡∏ö‡∏∏‡∏®‡∏¢‡πå ‡∏î‡∏≥‡∏£‡∏á‡∏Ñ‡πå‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ò‡∏ô‡∏¥‡∏ï‡∏≤  ‡∏´‡∏°‡∏∑‡πà‡∏ô‡∏ß‡∏¥‡∏ä‡∏¥‡∏ï","‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏à‡∏£‡∏¥‡∏ï  ‡∏†‡∏π‡πà‡∏†‡∏±‡∏Å‡∏î‡∏¥‡πå","‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå  ‡∏™‡∏¥‡∏á‡∏´‡∏≤","‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì  ‡∏û‡∏∂‡πà‡∏á‡∏ç‡∏≤‡∏ï‡∏¥","‡∏ô‡∏≤‡∏¢‡∏Å‡∏°‡∏•‡∏û‡∏±‡∏í‡∏ô‡πå  ‡∏õ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡∏≤","‡∏ô‡∏≤‡∏¢‡∏û‡∏á‡∏®‡πå‡∏ß‡∏¥‡∏£‡∏¥‡∏¢‡∏∞ ‡πÄ‡∏ä‡∏≤‡∏ß‡∏•‡∏¥‡∏ï‡∏£","‡∏ô‡∏≤‡∏¢‡∏ô‡∏±‡∏ó‡∏ò‡∏™‡∏¥‡∏ó‡∏ò‡∏¥  ‡∏Ñ‡πâ‡∏≥‡∏ä‡∏π","‡∏ô‡∏≤‡∏¢‡∏ì‡∏ê‡∏ä‡∏≤‡∏î‡∏• ‡∏¢‡∏¥‡πâ‡∏°‡∏™‡∏î","‡∏ô‡∏≤‡∏¢‡∏ó‡∏®‡∏û‡∏£  ‡∏ó‡∏¥‡∏û‡∏¢‡πå‡∏ó‡∏¥‡∏°‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏î‡∏•‡∏§‡∏ó‡∏±‡∏¢  ‡∏ï‡∏±‡∏ô‡∏ï‡∏¥‡∏ß‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå","‡∏ô‡∏≤‡∏¢‡∏ß‡∏£‡∏≤‡∏û‡∏• ‡∏ä‡∏±‡∏¢‡∏°‡∏ì‡∏µ","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏°‡∏±‡∏¢  ‡∏à‡∏±‡∏î‡∏†‡∏±‡∏¢","‡∏ô.‡∏™.‡∏ß‡∏£‡∏£‡∏©‡∏°‡∏• ‡∏ó‡∏≠‡∏á‡πÄ‡∏≠‡∏µ‡∏¢‡∏î","‡∏ô.‡∏™.‡∏Å‡∏∏‡∏•‡∏†‡∏£‡∏ì‡πå ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡πÄ‡∏à‡∏£‡∏¥‡∏ç"]; 
    groupData[5] = ["‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏¥‡∏•‡∏†‡∏≤  ‡πÅ‡∏û‡∏°‡∏ì‡∏µ","‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏©‡∏ì‡∏∏ ‡∏ä‡∏π‡∏õ‡∏£‡∏∞‡∏¢‡∏π‡∏£","‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ‡∏¢‡∏∏‡∏ß‡∏∞‡∏™‡∏∏‡∏ï","‡∏ô‡∏≤‡∏¢‡∏à‡∏±‡∏Å‡∏ß‡∏±‡∏ô  ‡∏≠‡∏ò‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏ô‡∏Å ‡∏û‡∏∏‡∏ó‡∏ò‡∏£‡∏±‡∏á‡∏©‡∏µ","‡∏ô‡∏≤‡∏á‡∏•‡∏•‡∏¥‡∏ï‡∏≤ ‡πÅ‡∏™‡∏ô‡∏™‡∏≠‡∏ô","‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏û‡∏±‡∏í‡∏ô‡πå‡∏û‡∏¥‡∏ó‡∏¢‡πå ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÄ‡∏Å‡∏©‡∏°","‡∏ô‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏á  ‡∏ä‡∏∑‡πà‡∏ô‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå","‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡∏©‡∏é‡∏≤‡∏Å‡∏£ ‡∏´‡∏≠‡∏°‡∏Å‡∏•‡∏¥‡πà‡∏ô","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏±‡∏ô‡∏ó‡πå‡∏ä‡∏ô‡∏Å ‡∏ô‡∏∏‡∏ä‡∏°‡∏¥‡∏ï‡∏£","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏£‡∏†‡∏±‡∏Ñ  ‡∏ò‡∏ô‡∏∞‡πÄ‡∏®‡∏ß‡∏ï","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ò‡∏ô‡∏±‡∏ä‡∏û‡∏£ ‡∏™‡∏∏‡∏Ç‡πÄ‡∏™‡∏£‡∏¥‡∏°","‡∏ô‡∏≤‡∏¢‡∏Å‡∏§‡∏ï‡∏û‡∏±‡∏í‡∏ô‡πå ‡πÅ‡∏Å‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏ò‡∏π‡∏õ"]; 
    groupData[6] = ["‡∏ô‡∏≤‡∏¢‡∏†‡∏±‡∏Ñ‡∏ß‡∏µ  ‡∏®‡∏¥‡∏•‡∏õ‡∏≤‡∏ô‡∏ô‡∏ó‡πå","‡∏ô.‡∏™.‡∏Å‡∏∏‡∏ì‡∏ä‡∏ç‡∏≤ ‡∏´‡∏¥‡∏ô‡πÄ‡∏ò‡∏≤‡∏ß‡πå","‡∏ô‡∏≤‡∏á‡∏û‡∏ä‡∏£‡∏°‡∏ô ‡∏™‡∏∏‡∏ó‡∏ò‡∏û‡∏¥‡∏ô‡∏ó‡∏∏","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏£‡∏ì‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏Å‡πâ‡∏ß‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°","‡∏ô‡∏≤‡∏¢‡∏ß‡∏£‡∏û‡∏• ‡∏™‡∏∏‡∏Ç‡∏™‡∏≥‡∏£‡∏≤‡∏ç","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏ß‡∏£‡∏£‡∏±‡∏ï‡∏ô‡πå  ‡∏õ‡∏è‡∏¥‡∏†‡∏≤‡∏ì‡∏ß‡∏±‡∏í‡∏ô‡πå","‡∏ô.‡∏™.‡∏ä‡∏ô‡∏Å‡∏†‡∏±‡∏ó‡∏£‡πå ‡∏î‡∏≤‡∏£‡∏≤‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏á‡∏Ñ‡πå","‡∏ô.‡∏™.‡∏à‡∏ì‡∏¥‡∏™‡∏ï‡∏≤ ‡∏ó‡∏¥‡∏¢‡∏≤","‡∏ô.‡∏™.‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤ ‡∏Å‡∏±‡∏á‡πÅ‡∏Æ","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ä‡∏ô‡∏±‡∏ï‡∏ï‡∏≤‡∏†‡∏≤  ‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏≤‡∏ß‡∏¥‡∏ô","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏û‡∏£‡∏ß‡∏¥‡∏†‡∏≤ ‡∏≠‡∏∏‡πà‡∏ô‡πÇ‡∏£‡∏à‡∏ô‡πå","‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏Å‡∏§‡∏ï ‡∏´‡∏≤‡∏ç‡∏ì‡∏£‡∏á‡∏Ñ‡πå","‡∏ô‡∏≤‡∏¢‡∏û‡∏ô‡∏¥‡∏ï ‡πÄ‡∏ó‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏ì‡∏†‡∏π‡∏°‡∏¥","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏£‡∏∏‡∏ì‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå ‡∏à‡∏¥‡∏£‡∏ò‡∏ô‡∏†‡∏¥‡∏ç‡πÇ‡∏ç","‡∏ô‡∏≤‡∏¢‡∏ä‡∏ô‡∏™‡∏£‡∏ì‡πå  ‡πÇ‡∏ï‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ê‡∏ô‡∏¥‡∏Å‡∏à‡∏•‡∏≤ ‡∏™‡∏±‡∏á‡∏Ç‡πå‡∏†‡∏¥‡∏£‡∏°‡∏¢‡πå","‡∏ô‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ë‡∏π‡∏£  ‡∏≠‡∏¥‡∏ô‡∏ó‡∏¥‡∏°","‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏¥‡∏Ñ‡∏£‡∏¥‡∏ô  ‡∏õ‡∏∏‡∏¢‡∏ô‡∏∏‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"]; 
    
    updateLineCount();
    nameListInput.addEventListener('input', updateLineCount);
    groupInputArea.addEventListener('input', () => {
        saveCurrentTabToMemory();
        updateGroupTabCount();
    });

    // --- Mode Switching ---
    function setMode(mode) {
        currentMode = mode;
        const simpleCont = document.getElementById('simpleModeContainer');
        const groupCont = document.getElementById('groupModeContainer');
        const btnSimple = document.getElementById('btnModeSimple');
        const btnGroup = document.getElementById('btnModeGroup');

        if (mode === 'simple') {
            simpleCont.classList.remove('hidden');
            groupCont.classList.add('hidden');
            btnSimple.classList.add('active');
            btnGroup.classList.remove('active');
            
            groupSelectorContainer.classList.add('hidden');
            simpleModeLabel.classList.remove('hidden');
        } else {
            simpleCont.classList.add('hidden');
            groupCont.classList.remove('hidden');
            btnSimple.classList.remove('active');
            btnGroup.classList.add('active');
            
            groupSelectorContainer.classList.remove('hidden');
            simpleModeLabel.classList.add('hidden');
            
            if (activeGroupTab === 0) {
                 switchGroupTab(2);
            } else {
                 switchGroupTab(activeGroupTab);
            }
        }
    }

    function initGroupTabs() {
        const container = document.getElementById('groupTabs');
        container.innerHTML = '';
        Object.keys(groupConfig).forEach(key => {
            const btn = document.createElement('button');
            btn.className = `px-3 py-1 text-xs rounded whitespace-nowrap transition-colors border border-gray-600 bg-gray-800 hover:bg-gray-700 text-gray-300`;
            btn.innerText = groupConfig[key].name;
            btn.dataset.group = key;
            btn.onclick = () => switchGroupTab(parseInt(key));
            container.appendChild(btn);
        });
    }

    function switchGroupTab(groupId) {
        if (activeGroupTab !== 1 && activeGroupTab !== 0) {
            saveCurrentTabToMemory();
        }
        activeGroupTab = groupId;
        const tabs = document.getElementById('groupTabs').children;
        for(let btn of tabs) {
            if(parseInt(btn.dataset.group) === groupId) {
                btn.className = `px-3 py-1 text-xs rounded whitespace-nowrap transition-colors border border-blue-500 bg-blue-600 text-white shadow`;
            } else {
                btn.className = `px-3 py-1 text-xs rounded whitespace-nowrap transition-colors border border-gray-600 bg-gray-800 hover:bg-gray-700 text-gray-300`;
            }
        }
        if (groupId === 1) {
            group1Overlay.classList.remove('hidden');
            groupInputArea.disabled = true;
            groupInputArea.value = ""; 
            updateAggregateDisplay();
        } else {
            group1Overlay.classList.add('hidden');
            groupInputArea.disabled = false;
            groupInputArea.value = groupData[groupId].join('\n');
            updateGroupTabCount();
        }
    }

    function saveCurrentTabToMemory() {
        if (activeGroupTab === 1 || activeGroupTab === 0) return;
        const text = groupInputArea.value;
        const list = text.split('\n').map(n => n.trim()).filter(n => n !== "");
        groupData[activeGroupTab] = list;
    }

    function updateGroupTabCount() {
        if (activeGroupTab === 1 || activeGroupTab === 0) return;
        const count = groupData[activeGroupTab].length;
        document.getElementById('groupCurrentCount').innerText = `${groupConfig[activeGroupTab].name}: ${count} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠`;
    }

    function updateAggregateDisplay() {
        let total = 0;
        for (let i = 2; i <= 6; i++) {
            total += groupData[i].length;
        }
        document.getElementById('group1TotalDisplay').innerText = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°: ${total} ‡∏Ñ‡∏ô`;
        document.getElementById('groupCurrentCount').innerText = `1. ‡∏≠‡∏™‡∏Ñ: ${total} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏£‡∏ß‡∏°)`;
    }

    function getCombinedGroup1List() {
        let combined = [];
        for (let i = 2; i <= 6; i++) {
            combined = combined.concat(groupData[i]);
        }
        return combined;
    }

    function saveAndCloseSetup() {
        if (currentMode === 'group') {
             saveCurrentTabToMemory();
        }
        toggleSetup();
        
        let count = 0;
        if (currentMode === 'simple') {
            count = nameListInput.value.split('\n').filter(n=>n.trim()).length;
        } else {
             const sel = raceGroupSelect.value;
             if (sel == 1) count = getCombinedGroup1List().length;
             else count = groupData[sel].length;
        }
        racerCountDisplay.innerText = `‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ${count} ‡∏Ñ‡∏ô`;
    }

    // --- Standard Logic ---

    function toggleSetup() {
        if (isRacing) return;
        setupModal.classList.toggle('hidden');
    }

    function generateData() {
        if (currentMode !== 'simple') {
            alert("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö (‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)");
            return;
        }
        const count = parseInt(document.getElementById('genAmount').value) || 100;
        const dummyNames = [];
        for (let i = 1; i <= count; i++) {
            dummyNames.push(`P${i.toString().padStart(3, '0')}`);
        }
        nameListInput.value = dummyNames.join('\n');
        updateLineCount();
    }

    function updateLineCount() {
        const lines = nameListInput.value.split('\n').filter(n => n.trim()).length;
        document.getElementById('lineCountSimple').innerText = `${lines} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠`;
        racerCountDisplay.innerText = `‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ${lines} ‡∏Ñ‡∏ô`;
    }

    function prepareAndStart() {
        if (isRacing) return;
        SoundManager.init();

        let rawNames = [];
        let groupName = "";

        if (currentMode === 'simple') {
            rawNames = nameListInput.value.split('\n').map(n => n.trim()).filter(n => n);
            groupName = "‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥";
        } else {
            const selectedGroupId = parseInt(raceGroupSelect.value);
            groupName = groupConfig[selectedGroupId].name;
            if (selectedGroupId === 1) {
                rawNames = getCombinedGroup1List();
            } else {
                rawNames = [...groupData[selectedGroupId]];
            }
        }

        if (rawNames.length === 0) { 
            alert(`‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° "${groupName}" ‡πÄ‡∏•‡∏¢!`); 
            toggleSetup(); 
            return; 
        }

        targetWinners = Math.min(parseInt(document.getElementById('winnerCount').value), rawNames.length);

        viewportWidth = trackArea.clientWidth;
        viewportHeight = trackArea.clientHeight;
        finishLineX = viewportWidth * TRACK_MULTIPLIER;

        const trackMsg = document.getElementById('trackMessage');
        if (trackMsg) {
            trackMsg.innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á: ${groupName}`;
        }

        setupTrack(rawNames);
        
        startBtn.disabled = true;
        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
        startBtn.innerText = "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß...";
        
        startCountdown();
    }

    function startCountdown() {
        let count = 3;
        countdownOverlay.classList.remove('hidden');
        
        const runStep = () => {
            countdownText.classList.remove('animate-pop');
            void countdownText.offsetWidth; 

            if (count > 0) {
                countdownText.innerText = count;
                countdownText.style.color = 'white';
                SoundManager.playBeep(440);
            } else {
                countdownText.innerText = "GO!";
                countdownText.style.color = '#fbbf24';
                SoundManager.playBeep(880);
            }
            
            countdownText.classList.add('animate-pop');

            if (count === 0) {
                setTimeout(() => {
                    countdownOverlay.classList.add('hidden');
                    isRacing = true;
                    SoundManager.playRaceMusic(); // Start Music Here
                    startBtn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô!";
                    startRaceLoop();
                }, 500);
            } else {
                count--;
                setTimeout(runStep, 1000);
            }
        };

        runStep();
    }

    function setupTrack(names) {
        racersLayer.innerHTML = '';
        markersLayer.innerHTML = '';
        racers = [];
        winners = [];
        worldContainer.style.transform = `translateX(0px)`;
        trackArea.style.backgroundPositionX = `0px`;

        // Add Finish Line & Label logic back
        finishLine.style.display = 'block';
        finishLine.style.left = `${finishLineX}px`;
        finishLabel.style.display = 'block';
        finishLabel.style.left = `${finishLineX - 40}px`;

        for (let i = 1; i <= 9; i++) {
            const leftPos = finishLineX * (i / 10);
            const line = document.createElement('div');
            line.className = 'absolute top-0 bottom-0 border-l-2 border-dashed border-white border-opacity-20 pointer-events-none';
            line.style.left = `${leftPos}px`;
            const labelTop = document.createElement('div');
            labelTop.className = 'absolute top-4 text-white text-opacity-40 font-bold text-xl transform -translate-x-1/2 pointer-events-none font-mono';
            labelTop.style.left = `${leftPos}px`;
            labelTop.innerText = `${i * 10}M`;
            markersLayer.appendChild(line);
            markersLayer.appendChild(labelTop);
        }

        const totalRacers = names.length;
        let avatarSize = "text-3xl";
        let labelSize = "text-xs";
        let iconOffsetY = -20;
        
        if (totalRacers > 150) {
            avatarSize = "text-lg"; labelSize = "text-[8px]"; iconOffsetY = -10;
        } else if (totalRacers > 50) {
            avatarSize = "text-2xl"; labelSize = "text-[10px]"; iconOffsetY = -15;
        }

        names.forEach((name, index) => {
            const progress = index / (totalRacers - 1 || 1); 
            const baseTop = 5 + (progress * 85);
            const randomJitter = (Math.random() * 2) - 1;
            const finalTop = Math.max(2, Math.min(95, baseTop + randomJitter));
            
            const el = document.createElement('div');
            el.className = "absolute left-0 flex flex-col items-center group horse-run select-none";
            el.style.top = `${finalTop}%`;
            el.style.zIndex = Math.floor(finalTop * 10); 
            
            const avatarChar = avatars[index % avatars.length];
            const colorClass = colors[index % colors.length];

            el.innerHTML = `
                <div class="${avatarSize} transform -scale-x-100 filter drop-shadow-sm leading-none relative z-10" style="top: ${iconOffsetY}px">
                    ${avatarChar}
                </div>
                <div class="${colorClass} text-white ${labelSize} px-1.5 rounded opacity-0 group-hover:opacity-100 transition-opacity absolute -top-4 whitespace-nowrap shadow-sm border border-black border-opacity-20 z-20">
                    ${name}
                </div>
                <div class="dust-container">
                    <div class="dust-particle"></div>
                    <div class="dust-particle"></div>
                    <div class="dust-particle"></div>
                </div>
            `;
            
            const labelEl = el.querySelector('div:nth-child(2)');
            const dustEl = el.querySelector('.dust-container');
            if(totalRacers < 30) labelEl.classList.remove('opacity-0');

            racersLayer.appendChild(el);

            racers.push({
                name: name,
                element: el,
                labelElement: labelEl,
                dustElement: dustEl,
                position: 0,
                yPercent: finalTop,
                currentSpeed: 0,
                targetSpeed: Math.random() * 5 + 5,
                maxSpeed: Math.random() * 8 + 8,
                aggression: Math.random() * 0.05 + 0.01,
                finished: false,
                wobble: Math.random() * 10,
            });
        });
    }

    function startRaceLoop() {
        let prevLeaderPosition = 0; 
        raceInterval = setInterval(() => {
            frameTick++;
            let activeCount = 0;
            let currentFrameLeaderPos = 0; 

            const shouldCheckProximity = (frameTick % 5 === 0);
            let racerPositions = [];
            if (shouldCheckProximity && racers.length > 30) { 
                 racerPositions = racers.map(r => ({ x: r.position, y: (r.yPercent / 100) * viewportHeight }));
            }

            racers.forEach((racer, index) => {
                if (racer.finished) {
                    currentFrameLeaderPos = Math.max(currentFrameLeaderPos, racer.position);
                    return;
                }
                
                activeCount++;

                const distToLeader = prevLeaderPosition - racer.position;

                if (Math.random() < racer.aggression) {
                    const progress = racer.position / finishLineX;
                    const fatigue = Math.random() > 0.7 ? 0.5 : 1;
                    const sprintBonus = (progress > 0.8) ? 1.5 : 1;
                    let catchUpBonus = 1;
                    const isFewRacers = racers.length <= 20; 

                    if (distToLeader > 0) {
                        if (isFewRacers) {
                             catchUpBonus = 1 + (distToLeader / 1500); 
                             if (distToLeader > viewportWidth * 0.25) catchUpBonus += 0.4; 
                        } else {
                             catchUpBonus = 1 + (distToLeader / 3000); 
                             if (distToLeader > viewportWidth) catchUpBonus += 0.3; 
                        }
                    } else {
                        catchUpBonus = isFewRacers ? 0.85 : 0.95; 
                    }

                    racer.targetSpeed = (Math.random() * racer.maxSpeed * fatigue * sprintBonus * catchUpBonus);
                    if(racer.targetSpeed < 2) racer.targetSpeed = 2 + Math.random();
                }

                racer.currentSpeed += (racer.targetSpeed - racer.currentSpeed) * 0.05;

                if (racer.targetSpeed > racer.currentSpeed + 0.5 && racer.currentSpeed > 3) {
                    racer.dustElement.classList.add('active');
                } else {
                    racer.dustElement.classList.remove('active');
                }

                const speedScale = viewportWidth / 1200; 
                racer.position += racer.currentSpeed * speedScale;

                racer.wobble += 0.5 + (racer.currentSpeed * 0.05);
                const jumpY = Math.abs(Math.sin(racer.wobble)) * -3;
                racer.element.style.transform = `translate(${racer.position}px, ${jumpY}px)`;

                if (shouldCheckProximity && racers.length > 30) {
                    let isIsolated = true;
                    const myX = racer.position;
                    const myY = (racer.yPercent / 100) * viewportHeight;
                    for (let j = 0; j < racerPositions.length; j++) {
                        if (index === j) continue;
                        const other = racerPositions[j];
                        const dx = Math.abs(myX - other.x);
                        const dy = Math.abs(myY - other.y);
                        if (dx < 60 && dy < 60 && (dx*dx + dy*dy) < 3600) {
                            isIsolated = false;
                            break;
                        }
                    }
                    if (isIsolated) {
                        racer.labelElement.classList.remove('opacity-0');
                        racer.labelElement.classList.add('force-show-name'); 
                    } else {
                        racer.labelElement.classList.remove('force-show-name');
                        racer.labelElement.classList.add('opacity-0');
                    }
                }

                if (racer.position >= finishLineX) {
                    racer.position = finishLineX;
                    racer.finished = true;
                    racer.dustElement.classList.remove('active'); 
                    racer.labelElement.classList.remove('opacity-0');
                    racer.labelElement.classList.add('force-show-name'); 

                    if (winners.length < targetWinners) {
                        winners.push(racer);
                        racer.element.classList.add('brightness-125', 'scale-125', 'z-50');
                        racer.element.innerHTML += `<div class="absolute -top-8 text-2xl animate-bounce">üö©</div>`;
                    }
                }

                currentFrameLeaderPos = Math.max(currentFrameLeaderPos, racer.position);
            });

            prevLeaderPosition = currentFrameLeaderPos;

            let cameraX = prevLeaderPosition - (viewportWidth * 0.6);
            if (cameraX < 0) cameraX = 0;
            if (cameraX > finishLineX - viewportWidth + 100) { 
                cameraX = finishLineX - viewportWidth + 100; 
            }
            worldContainer.style.transform = `translateX(${-cameraX}px)`;
            trackArea.style.backgroundPositionX = `${-cameraX}px`;

            const progressPct = Math.min(100, Math.round((prevLeaderPosition / finishLineX) * 100));
            distanceDisplay.innerText = `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${progressPct}%`;

            if (winners.length >= targetWinners || activeCount === 0) {
                clearInterval(raceInterval);
                finishGame();
            }

        }, 30);
    }

    function finishGame() {
        isRacing = false;
        startBtn.disabled = false;
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        startBtn.innerText = "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏´‡∏°‡πà";
        SoundManager.stopRaceMusic(); // Stop Music
        SoundManager.playVictory();
        startFireworks();

        let subtitle = "";
        if (currentMode === 'simple') subtitle = "‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥";
        else {
            const gid = raceGroupSelect.value;
            subtitle = `‡∏Å‡∏•‡∏∏‡πà‡∏°: ${groupConfig[gid].name}`;
        }
        document.getElementById('resultSubtitle').innerText = subtitle;

        const list = document.getElementById('winnerList');
        list.innerHTML = '';
        winners.forEach((w, i) => {
            const rank = i + 1;
            let badge = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
            const li = document.createElement('li');
            li.className = "flex items-center gap-3 p-2 bg-white border-b hover:bg-gray-50";
            li.innerHTML = `<div class="text-xl w-8 text-center font-bold text-gray-700">${badge}</div><div class="font-bold text-gray-800 flex-1">${w.name}</div>`;
            list.appendChild(li);
        });

        const modal = document.getElementById('resultModal');
        modal.classList.remove('hidden');
        void modal.offsetWidth; 
        modal.querySelector('div').classList.remove('scale-90', 'opacity-0');
        modal.querySelector('div').classList.add('scale-100', 'opacity-100');
    }

    function nextRound() {
        const winnerNames = winners.map(w => w.name);

        if (currentMode === 'simple') {
            const currentList = nameListInput.value.split('\n').map(n => n.trim()).filter(n => n !== "");
            const nextRoundList = currentList.filter(name => !winnerNames.includes(name));
            if (nextRoundList.length === 0) {
                alert("‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß! (‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô)");
                closeResult();
                nameListInput.value = "";
                updateLineCount();
                return;
            }
            nameListInput.value = nextRoundList.join('\n');
            updateLineCount();
        } else {
            let removedCount = 0;
            let remainingTotal = 0;
            for (let i = 2; i <= 6; i++) {
                const originalLen = groupData[i].length;
                groupData[i] = groupData[i].filter(name => !winnerNames.includes(name));
                if (groupData[i].length < originalLen) removedCount++;
                remainingTotal += groupData[i].length;
            }
            if (remainingTotal === 0) {
                alert("‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß! (‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°)");
                closeResult();
                updateAggregateDisplay(); 
                racerCountDisplay.innerText = "‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: 0 ‡∏Ñ‡∏ô";
                return;
            }
        }

        let nextRaceCount = 0;
        if(currentMode === 'simple') {
            nextRaceCount = nameListInput.value.split('\n').filter(n=>n.trim()).length;
        } else {
            const sel = raceGroupSelect.value;
            if (sel == 1) nextRaceCount = getCombinedGroup1List().length;
            else nextRaceCount = groupData[sel].length;
        }
        racerCountDisplay.innerText = `‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ${nextRaceCount} ‡∏Ñ‡∏ô`;

        startBtn.innerText = "üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
        closeResult();
    }

    function closeResult() {
        stopFireworks();
        const modal = document.getElementById('resultModal');
        modal.querySelector('div').classList.remove('scale-100', 'opacity-100');
        modal.querySelector('div').classList.add('scale-90', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // --- Fireworks ---
    const fwCanvas = document.getElementById('fireworksCanvas');
    const fwCtx = fwCanvas.getContext('2d');
    let fwParticles = [];
    let fwAnimationId;

    function resizeCanvas() {
        fwCanvas.width = window.innerWidth;
        fwCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    class FireworkParticle {
        constructor(x, y, hue) {
            this.x = x; y = y; this.hue = hue;
            const angle = Math.random() * Math.PI * 2;
            const velocity = Math.random() * 6 + 2;
            this.vx = Math.cos(angle) * velocity;
            this.vy = Math.sin(angle) * velocity;
            this.alpha = 1; this.decay = Math.random() * 0.015 + 0.015; this.gravity = 0.1;
        }
        update() {
            this.x += this.vx; this.y += this.vy; this.vy += this.gravity;
            this.alpha -= this.decay; this.vx *= 0.96; this.vy *= 0.96;
        }
        draw(ctx) {
            ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath();
            ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
            ctx.fillStyle = `hsl(${this.hue}, 100%, 50%)`; ctx.fill(); ctx.restore();
        }
    }

    function createFirework() {
        SoundManager.playFireworkPop();
        const x = Math.random() * fwCanvas.width;
        const y = Math.random() * (fwCanvas.height * 0.6) + (fwCanvas.height * 0.1);
        const hue = Math.random() * 360;
        for (let i = 0; i < 50; i++) fwParticles.push(new FireworkParticle(x, y, hue));
    }

    function animateFireworks() {
        fwCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);
        fwParticles = fwParticles.filter(p => p.alpha > 0);
        fwParticles.forEach(p => { p.update(); p.draw(fwCtx); });
        if (Math.random() < 0.05) createFirework();
        fwAnimationId = requestAnimationFrame(animateFireworks);
    }

    function startFireworks() {
        fwParticles = []; fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        animateFireworks(); createFirework();
        setTimeout(createFirework, 300); setTimeout(createFirework, 600);
    }

    function stopFireworks() {
        cancelAnimationFrame(fwAnimationId); fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height); fwParticles = [];
    }

</script>
</body>
</html>
